// schema.prisma
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============ NextAuth.js Required Tables ============

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

// ============ Authentication & Organization ============

model Organization {
  id          String   @id @default(cuid())
  name        String
  slug        String   @unique
  plan        Plan     @default(FREE)
  status      OrgStatus @default(ACTIVE)
  
  // Contact Information
  contactEmail String?
  contactPhone String?
  address      Json?    // Flexible address structure
  
  // Settings
  settings     Json     @default("{}")  // Organization-specific settings
  
  // Timestamps
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  
  // Relationships
  users        User[]
  rules        Rule[]
  ecrReports   ECRReport[]
  
  @@map("organizations")
}

enum Plan {
  FREE
  PROFESSIONAL
  ENTERPRISE
  STATE_LICENSE
}

enum OrgStatus {
  ACTIVE
  SUSPENDED
  TRIAL
}

model User {
  id             String    @id @default(cuid())
  email          String    @unique
  name           String?
  password       String?   // For credentials authentication
  role           UserRole  @default(VIEWER)
  
  // Authentication
  emailVerified  DateTime?
  image          String?
  
  // Organization relationship
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  // Timestamps
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  lastLoginAt    DateTime?
  
  // Relationships
  accounts       Account[]
  sessions       Session[]
  createdRules   Rule[]    @relation("RuleCreator")
  
  @@map("users")
}

enum UserRole {
  ADMIN      // Full organization access
  BUILDER    // Can create and edit rules
  VIEWER     // Read-only access
}

// ============ Rule Management System ============

model Rule {
  id                  String        @id @default(cuid())
  
  // Basic Information
  name                String
  description         String?       @db.Text
  reportableCondition String        // Primary condition this rule detects
  
  // Rule Configuration  
  category            RuleCategory
  status              RuleStatus    @default(DRAFT)
  priority            Int           @default(5) // 1-10 priority scale
  
  // Rule Logic (stored as JSON for flexibility)
  conditions          Json          // IF conditions
  actions             Json          // THEN actions
  fhirMapping         Json?         // FHIR resource mappings
  
  // Validation
  isValid             Boolean       @default(false)
  validationErrors    Json?         // Validation error details
  
  // Versioning
  version             Int           @default(1)
  parentRuleId        String?       // For rule versions
  
  // Organization relationship
  organizationId      String
  organization        Organization  @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  // Audit
  createdById         String
  createdBy           User          @relation("RuleCreator", fields: [createdById], references: [id])
  
  // Timestamps
  createdAt           DateTime      @default(now())
  updatedAt           DateTime      @updatedAt
  publishedAt         DateTime?
  
  // Relationships
  versions            Rule[]        @relation("RuleVersions")
  parentRule          Rule?         @relation("RuleVersions", fields: [parentRuleId], references: [id])
  executions          RuleExecution[]
  
  // Indexes
  @@index([organizationId, status])
  @@index([reportableCondition])
  @@index([createdAt])
  @@map("rules")
}

enum RuleCategory {
  CONDITION_DETECTION    // Detects reportable conditions
  DATA_VALIDATION       // Validates incoming data
  ROUTING               // Routes reports to specific agencies
  TRANSFORMATION        // Transforms data format
}

enum RuleStatus {
  DRAFT                 // Being created/edited
  TESTING               // Under testing
  PUBLISHED             // Live and active
  ARCHIVED              // No longer active
  ERROR                 // Has validation errors
}

// ============ Rule Execution & Monitoring ============

model RuleExecution {
  id              String            @id @default(cuid())
  
  // Rule reference
  ruleId          String
  rule            Rule              @relation(fields: [ruleId], references: [id])
  
  // Execution details
  status          ExecutionStatus   @default(PENDING)
  startedAt       DateTime          @default(now())
  completedAt     DateTime?
  duration        Int?              // Duration in milliseconds
  
  // Input/Output
  inputData       Json              // Input FHIR data
  outputData      Json?             // Generated eCR report
  errorMessage    String?
  
  // Metadata
  triggeredBy     String?           // User or system that triggered
  executionContext Json?            // Additional context
  
  @@index([ruleId, startedAt])
  @@map("rule_executions")
}

enum ExecutionStatus {
  PENDING
  RUNNING
  COMPLETED
  FAILED
  TIMEOUT
}

// ============ eCR Reports Management ============

model ECRReport {
  id                String        @id @default(cuid())
  
  // Report identification
  reportId          String        @unique // External report ID
  reportType        ECRReportType @default(INITIAL)
  
  // Patient & Clinical Info
  patientId         String?       // Patient identifier
  reportableCondition String      // Condition being reported
  diagnosisDate     DateTime?
  
  // Report content
  fhirBundle        Json          // Complete FHIR bundle
  ccdaDocument      String?       // C-CDA document if needed
  
  // Routing & Delivery
  targetAgencies    String[]      // Health departments to receive report
  deliveryStatus    DeliveryStatus @default(PENDING)
  deliveredAt       DateTime?
  
  // Audit trail
  organizationId    String
  organization      Organization  @relation(fields: [organizationId], references: [id])
  
  // Timestamps
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt
  
  @@index([organizationId, createdAt])
  @@index([reportableCondition])
  @@map("ecr_reports")
}

enum ECRReportType {
  INITIAL           // Initial case report
  UPDATE            // Update to existing case
  CORRECTION        // Correction to previous report
}

enum DeliveryStatus {
  PENDING           // Waiting to be sent
  SENT              // Successfully delivered
  FAILED            // Delivery failed
  ACKNOWLEDGED      // Acknowledged by receiving agency
}

// ============ System Configuration ============

model SystemConfig {
  id            String    @id @default(cuid())
  key           String    @unique
  value         Json
  description   String?
  category      String    @default("general")
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  @@map("system_config")
}

// ============ Audit Logging ============

model AuditLog {
  id            String    @id @default(cuid())
  
  // Event details
  action        String    // CREATE, UPDATE, DELETE, EXECUTE
  resourceType  String    // Rule, Organization, User, etc.
  resourceId    String    // ID of the affected resource
  
  // Changes
  previousData  Json?     // Data before change
  newData       Json?     // Data after change
  
  // User context
  userId        String?
  organizationId String?
  
  // Request context
  ipAddress     String?
  userAgent     String?
  
  // Timestamp
  createdAt     DateTime  @default(now())
  
  @@index([resourceType, resourceId])
  @@index([userId])
  @@index([createdAt])
  @@map("audit_logs")
}